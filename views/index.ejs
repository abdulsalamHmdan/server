<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ÙØ±ÙˆØ¹ â€” Ø¹Ø±Ø¶ Ø¨Ø³ÙŠØ· â€¢ Ø¥Ø¯Ø§Ø±Ø© Ø¯Ù‚ÙŠÙ‚Ø©</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style id="appCSS">
    :root{
      /* Apple: quiet palette + depth */
      --bg: #f6f7f9;
      --paper: rgba(255,255,255,.86);
      --card: #ffffff;
      --ink: #0b1220;
      --sub: rgba(11,18,32,.62);
      --line: rgba(11,18,32,.10);
      --line2: rgba(11,18,32,.07);

      --shadow: 0 26px 72px rgba(16,24,40,.12);
      --shadow2: 0 14px 34px rgba(16,24,40,.10);

      --r-xl: 28px;
      --r-lg: 22px;
      --r-md: 16px;
      --r-sm: 12px;

      /* Google: functional blue, but toned down */
      --accent: #2563eb;
      --accent2:#0f172a;
      --ok: #10b981;
      --warn:#f59e0b;

      /* Stage colors (soft, craft) */
      --s1:#2563eb;
      --s2:#06b6d4;
      --s3:#10b981;
      --s4:#f59e0b;
      --s5:#ef4444;
      --s6:#a855f7;

      /* Japanese craft: rhythm + precision */
      --space: 14px;
      --space2: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"IBM Plex Sans Arabic", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(900px 650px at 88% -10%, rgba(37,99,235,.10), transparent 58%),
        radial-gradient(850px 600px at 8% 0%, rgba(16,185,129,.08), transparent 55%),
        var(--bg);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }

    /* Top bar (Jony Ive: minimal, exact) */
    .top{
      position:sticky; top:0; z-index:50;
      padding: 12px 12px 10px;
      backdrop-filter: blur(12px);
      background: rgba(246,247,249,.72);
      border-bottom:1px solid var(--line2);
    }
    .topInner{
      max-width:1240px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .mark{
      width:34px; height:34px; border-radius:12px;
      background: linear-gradient(180deg, #111827, #0b1220);
      box-shadow: 0 14px 30px rgba(17,24,39,.20);
      position:relative;
    }
    .mark:after{
      content:""; position:absolute; inset:8px; border-radius:8px;
      background: linear-gradient(180deg, rgba(255,255,255,.22), rgba(255,255,255,.04));
    }
    .brand h1{margin:0; font-size:14px; font-weight:1000; letter-spacing:.2px}
    .brand p{margin:2px 0 0; font-size:12px; font-weight:900; color:var(--sub)}

    .seg{
      display:flex; gap:6px;
      padding:5px;
      border-radius:999px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.78);
      box-shadow: var(--shadow2);
    }
    .seg button{
      border:0; background:transparent; cursor:pointer;
      padding:10px 14px;
      border-radius:999px;
      font-weight:1000; font-size:13px;
      color: rgba(11,18,32,.72);
      transition: .14s ease;
    }
    .seg button.active{
      background:#fff;
      color: var(--ink);
      box-shadow: 0 10px 18px rgba(16,24,40,.10);
    }

    .actions{display:flex; gap:10px; flex-wrap:wrap}
    .btn{
      appearance:none;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.84);
      color: var(--ink);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight:1000;
      font-size:13px;
      cursor:pointer;
      transition:.14s ease;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      user-select:none;
      box-shadow: 0 10px 20px rgba(16,24,40,.07);
    }
    .btn:hover{transform: translateY(-1px)}
    .btn:active{transform: translateY(0)}
    .btn.primary{
      border-color: transparent;
      background: linear-gradient(180deg, var(--accent2), #0b1220);
      color:#fff;
      box-shadow: 0 16px 30px rgba(15,23,42,.24);
    }
    .btn.ghost{background:transparent; box-shadow:none}
    .btn.danger{border-color: rgba(239,68,68,.35); color:#b91c1c; box-shadow:none; background:#fff}
    .btn.small{padding:8px 10px; border-radius:12px; font-size:12px; box-shadow:none}

    /* Layout */
    .wrap{max-width:1240px; margin:0 auto; padding: 12px 12px 26px}
    .layout{
      display:grid;
      grid-template-columns: 1.12fr .88fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 980px){ .layout{grid-template-columns:1fr} }

    /* Panels */
    .panel{
      background: var(--paper);
      border: 1px solid var(--line2);
      border-radius: var(--r-xl);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHead{
      padding: 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      border-bottom:1px solid var(--line2);
      background: rgba(255,255,255,.72);
    }
    .panelHead b{font-size:13px; font-weight:1000}
    .panelBody{padding:14px}

    /* Search + list (Apple Photos-like) */
    .searchRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .search{
      flex:1; min-width:240px;
      border:1px solid var(--line2);
      background:#fff;
      border-radius: 14px;
      padding: 10px 12px;
      outline:none;
      font-weight:900;
      font-size:13px;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.84);
      font-size:12px;
      font-weight:1000;
      color: rgba(11,18,32,.78);
      white-space:nowrap;
    }

    .list{
      padding: 12px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
    }
    @media (max-width: 760px){ .list{grid-template-columns:1fr} }

    /* Card (Japanese craft: clean structure, no noise) */
    .card{
      background: linear-gradient(180deg, #fff, rgba(255,255,255,.92));
      border:1px solid rgba(11,18,32,.08);
      border-radius: 22px;
      box-shadow: 0 14px 30px rgba(16,24,40,.10);
      padding: 12px;
      cursor:pointer;
      transition: .14s ease;
      position:relative;
      overflow:hidden;
    }
    .card:hover{transform: translateY(-2px)}
    .card.selected{
      outline: 3px solid rgba(37,99,235,.18);
      border-color: rgba(37,99,235,.20);
    }
    .cardTop{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .name{
      font-size: 18px;
      font-weight:1000;
      line-height:1.15;
      margin:0;
    }
    .kpi{
      text-align:left;
      min-width: 140px;
    }
    .kpi .l{font-size:11px; font-weight:1000; color:rgba(11,18,32,.45)}
    .kpi .v{font-size:16px; font-weight:1000; margin-top:4px}
    .kpi .v strong{font-size:18px}

    .meta{
      display:flex; flex-wrap:wrap; gap:8px;
      margin-bottom:10px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 9px;
      border-radius:999px;
      border:1px solid rgba(11,18,32,.08);
      background: rgba(248,250,252,.75);
      font-size:11px;
      font-weight:1000;
      color: rgba(11,18,32,.75);
    }
    .pill span{color: rgba(11,18,32,.45); font-weight:900}

    /* Single progress (current + stages + remaining) */
    .barWrap{margin-top:8px}
    .bar{
      height: 14px;
      border-radius: 999px;
      overflow:hidden;
      border:1px solid rgba(11,18,32,.08);
      background: #f3f4f6;
      display:flex;
    }
    .segm{height:100%}
    .legend{display:flex; flex-wrap:wrap; gap:8px; margin-top:9px}
    .leg{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 9px;
      border-radius:999px;
      border:1px solid rgba(11,18,32,.08);
      background: rgba(255,255,255,.78);
      font-size:11px; font-weight:1000;
      color: rgba(11,18,32,.72);
      white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:999px;border:1px solid rgba(0,0,0,.12)}

    /* Inspector (Apple Settings + Google clarity) */
    .inspector{
      position:sticky; top:84px;
    }
    @media (max-width: 980px){ .inspector{position:static} }

    .hero{
      padding: 16px;
      background:
        radial-gradient(700px 450px at 20% 0%, rgba(37,99,235,.14), transparent 62%),
        rgba(255,255,255,.72);
      border-bottom:1px solid var(--line2);
    }
    .hero h2{
      margin:0;
      font-size: 22px;
      font-weight:1000;
      letter-spacing:.1px;
      line-height:1.15;
    }
    .hero p{
      margin:6px 0 0;
      color: var(--sub);
      font-size:12px;
      font-weight:900;
      line-height:1.7;
    }

    .big{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      padding: 12px;
    }
    .tile{
      border:1px solid var(--line2);
      background: rgba(255,255,255,.86);
      border-radius: 18px;
      padding: 12px;
    }
    .tile .t{font-size:12px; font-weight:1000; color:var(--sub)}
    .tile .v{
      margin-top:8px;
      font-size: 30px;
      font-weight:1000;
      line-height:1.05;
      letter-spacing:.1px;
      color: var(--ink);
    }
    .tile .v .cur{font-size:14px; font-weight:1000; color:rgba(11,18,32,.55); margin-right:6px}
    .tile .s{margin-top:8px; font-size:12px; font-weight:900; color:var(--sub); line-height:1.7}

    .stageGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
      padding: 12px;
    }
    @media (max-width: 980px){ .stageGrid{grid-template-columns:1fr} }

    .stage{
      border:1px solid rgba(11,18,32,.08);
      background: rgba(255,255,255,.86);
      border-radius: 18px;
      padding: 12px;
      overflow:hidden;
      position:relative;
    }
    .stage:before{
      content:"";
      position:absolute; inset:0 0 auto 0;
      height:6px;
      background: var(--stageColor, var(--s1));
    }
    .stage .row{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .stage .row b{font-size:12px; font-weight:1000}
    .stage .row span{font-size:11px; font-weight:900; color:var(--sub)}
    .stage .lbl{font-size:12px; font-weight:1000; color:var(--sub); margin-bottom:6px}
    .stage .amt{
      font-size: 34px;
      font-weight:1000;
      line-height:1.05;
      color: var(--ink);
    }
    .stage .amt .cur{font-size:14px; font-weight:1000; color:rgba(11,18,32,.55); margin-right:6px}

    /* Manage */
    .note{
      font-size:12px;
      font-weight:900;
      color: var(--sub);
      line-height:1.7;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.82);
      border-radius: 18px;
      padding: 12px;
    }
    .note code{
      font-family: var(--mono);
      font-weight:1000;
      background:#f8fafc;
      border:1px solid rgba(11,18,32,.08);
      padding:2px 6px;
      border-radius:8px;
    }

    .form{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 980px){ .form{grid-template-columns:1fr} }

    .field{display:flex; flex-direction:column; gap:6px}
    .field label{font-size:12px; font-weight:900; color: var(--sub)}
    .field input, .field select, .field textarea{
      border:1px solid var(--line2);
      background:#fff;
      border-radius: 14px;
      padding:10px 12px;
      outline:none;
      font-size:13px;
      font-weight:900;
    }
    .field textarea{min-height:120px; resize:vertical; font-family:var(--mono); font-weight:800; font-size:12px; line-height:1.6}

    .tableWrap{
      margin-top:12px;
      border:1px solid var(--line2);
      border-radius: 18px;
      overflow:auto;
      background:#fff;
    }
    table{border-collapse:separate; border-spacing:0; width:100%; min-width: 900px; font-size:12px}
    th, td{
      padding:10px;
      border-bottom:1px solid var(--line2);
      border-left:1px solid var(--line2);
      text-align:right;
      vertical-align:top;
      background:#fff;
    }
    th:last-child, td:last-child{border-left:none}
    th{
      position:sticky; top:0;
      background:#f8fafc;
      font-weight:1000;
      white-space:nowrap;
      z-index:1;
    }
    tr:last-child td{border-bottom:none}
    .cell{
      width:100%;
      border:1px solid transparent;
      border-radius: 10px;
      padding:8px 10px;
      outline:none;
      font:inherit;
      font-weight:900;
      background:transparent;
    }
    .cell:focus{
      border-color: rgba(37,99,235,.35);
      box-shadow: 0 0 0 3px rgba(37,99,235,.15);
      background:#fff;
    }

    .stageBuilder{
      margin-top:12px;
      border:1px solid var(--line2);
      border-radius: 18px;
      background: rgba(255,255,255,.82);
      padding:12px;
    }
    .stageItem{
      border:1px solid rgba(11,18,32,.08);
      background:#fff;
      border-radius: 16px;
      padding:10px;
      margin-top:10px;
    }
    .stageTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid var(--line2);
      background:#f8fafc;
      font-size:11px;
      font-weight:1000;
      color: rgba(11,18,32,.78);
    }
    .swatch{width:14px;height:14px;border-radius:999px;border:1px solid rgba(0,0,0,.12)}
    .stageForm{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:10px;
    }
    @media (max-width: 980px){ .stageForm{grid-template-columns:1fr} }

    /* Print / export (native print only) */
    @media print{
      .top, .no-print{display:none!important}
      body{background:#fff!important}
      .wrap{max-width:none; padding:0}
      .layout{grid-template-columns:1fr}
      .panel{box-shadow:none; border:none; border-radius:0}
      .card{box-shadow:none}
      .inspector{position:static}
    }
  

    /* Mobile polish (phone-first). Keeps all features; only adjusts layout/typography for small screens. */
    @media (max-width: 640px){
      .wrap{padding: 10px 10px 90px;} /* extra bottom space for mobile nav */
      .top{position:sticky; top:0; z-index:60; backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px);}
      .topInner{flex-direction:column; align-items:stretch; gap:10px;}
      .brand{gap:10px}
      .brand h1{font-size:16px}
      .brand p{font-size:12px; line-height:1.25}
      .seg{width:100%; overflow:auto; -webkit-overflow-scrolling:touch; justify-content:flex-start}
      .seg button{flex:0 0 auto; min-width: 92px; padding:10px 12px; font-size:13px}
      .actions{width:100%; flex-wrap:wrap}
      .actions .btn{flex: 1 1 calc(50% - 8px); justify-content:center; padding:10px 12px; border-radius: 16px}
      .actions .btn.small{flex: 1 1 calc(50% - 8px)}
      .panel{border-radius: 18px}
      .panelHead{padding: 12px; gap:10px}
      .searchRow{min-width:100%}
      .search{font-size:16px} /* prevent iOS zoom */
      .chip{padding:8px 10px; font-size:12px}

      /* Cards */
      .list{padding: 10px; gap: 10px}
      .card{border-radius: 18px; padding: 12px}
      .cardTop{flex-direction:column; align-items:stretch; gap:8px}
      .name{font-size:17px}
      .kpi{min-width:0; text-align:right}
      .kpi .v{font-size:15px}
      .kpi .v strong{font-size:18px}
      .meta{gap:6px}
      .pill{font-size:12px; padding:8px 10px}

      /* Progress + stages */
      .progressRow{gap:10px}
      .progressBar{height: 12px}
      .stageStrip{gap:8px; flex-wrap:wrap}
      .stagePill{flex: 1 1 calc(50% - 8px); min-width: 0}
      .stagePill .t{font-size:12px}
      .stagePill .v{font-size:14px}

      /* Manage / settings forms */
      .form{grid-template-columns: 1fr !important}
      .field{grid-column:1/-1 !important}
      input, select, textarea{font-size:16px} /* tap-friendly, no zoom */
      .tableWrap{border-radius: 16px}
      table{min-width: 860px} /* still scrollable; slightly lighter */

      /* Reduce motion on phones for comfort */
      .card:hover{transform:none}
    }

    /* Mobile bottom nav */
    .mNav{display:none}
    @media (max-width: 640px){
      .mNav{
        position: fixed;
        left: 10px;
        right: 10px;
        bottom: 10px;
        z-index: 80;
        display:flex;
        gap: 10px;
        align-items:center;
        justify-content:space-between;
        padding: 10px 12px;
        border-radius: 20px;
        background: rgba(255,255,255,.86);
        border: 1px solid rgba(11,18,32,.10);
        box-shadow: 0 20px 60px rgba(16,24,40,.18);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
      }
      .mNavBtn{
        appearance:none; border:0; background:transparent;
        display:flex; flex-direction:column; align-items:center; justify-content:center;
        gap:6px;
        min-width: 54px;
        padding: 8px 6px;
        border-radius: 16px;
        color: rgba(11,18,32,.80);
        font-weight:1000;
        cursor:pointer;
        transition: .12s ease;
      }
      .mNavBtn:active{transform: scale(.98)}
      .mI{font-size:18px; line-height:1}
      .mT{font-size:11px; line-height:1}
      .mSep{width:1px; height:34px; background: rgba(11,18,32,.10); border-radius: 999px}
    }


    /* Detail sheet (mobile master-detail) */
    .sheetBackdrop{
      position:fixed; inset:0; z-index:90;
      background: rgba(11,18,32,.38);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    .sheet{
      position:fixed;
      left:10px; right:10px; bottom:10px;
      z-index:95;
      border-radius: 24px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(11,18,32,.10);
      box-shadow: 0 28px 90px rgba(16,24,40,.28);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
      max-height: calc(88vh - 10px);
      display:flex;
      flex-direction:column;
      transform: translateY(12px);
      opacity: 0;
      pointer-events:none;
      transition: .18s ease;
    }
    .sheet.isOpen{ transform: translateY(0); opacity:1; pointer-events:auto; }
    .sheetHandle{
      width: 52px; height: 6px; border-radius: 999px;
      background: rgba(11,18,32,.14);
      margin: 10px auto 0;
    }
    .sheetHead{
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px;
      padding: 10px 12px 8px;
      border-bottom: 1px solid rgba(11,18,32,.08);
    }
    .sheetTitle{min-width:0}
    .sheetKicker{font-size:11px; color: rgba(11,18,32,.55); font-weight:800; letter-spacing:.02em}
    .sheetName{font-size:16px; font-weight:1000; color: rgba(11,18,32,.86); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .sheetNav{display:flex; gap:8px}
    .sheetBody{padding: 12px; overflow:auto; -webkit-overflow-scrolling:touch}

    /* Keep the large detail panel visible on desktop; on mobile prefer sheet to avoid jumping */
    @media (max-width: 640px){
      .detailPanel{display:none !important;} /* we still render data (for exports/desktop), but hide in phone */
      .list{display:grid; grid-template-columns: 1fr; gap: 10px; }
    }
    @media (max-width: 640px) and (min-width: 460px){
      .list{grid-template-columns: 1fr 1fr;}
    }

    /* Sheet inner blocks (use same visual language) */
    .sheetCard{
      border-radius: 18px;
      background: rgba(255,255,255,.70);
      border: 1px solid rgba(11,18,32,.08);
      box-shadow: 0 10px 30px rgba(16,24,40,.08);
      overflow:hidden;
      margin-bottom: 10px;
    }
    .sheetCard .pad{padding: 12px}
    .sheetGrid{
      display:grid; grid-template-columns: 1fr 1fr; gap: 10px;
    }
    .sheetGrid .tile{
      background: rgba(255,255,255,.60);
      border: 1px solid rgba(11,18,32,.08);
      border-radius: 16px;
      padding: 10px;
      box-shadow: 0 10px 20px rgba(16,24,40,.06);
    }
    .sheetGrid .tile .t{font-size:11px; color: rgba(11,18,32,.55); font-weight:900}
    .sheetGrid .tile .v{font-size:15px; font-weight:1000; margin-top:6px}
    .sheetGrid .tile .s{font-size:12px; color: rgba(11,18,32,.55); margin-top:4px}
    .sheetStages{
      display:grid; grid-template-columns: 1fr; gap: 10px;
    }
    .sheetStage{
      border-radius: 16px;
      border: 1px solid rgba(11,18,32,.08);
      background: rgba(255,255,255,.60);
      box-shadow: 0 10px 20px rgba(16,24,40,.06);
      padding: 10px;
    }
    .sheetStage .row{display:flex; justify-content:space-between; gap:10px; align-items:center}
    .sheetStage b{font-weight:1000}
    .sheetStage .lbl{font-size:11px; color: rgba(11,18,32,.55); font-weight:900; margin-top:6px}
    .sheetStage .amt{font-size:20px; font-weight:1100; letter-spacing:.01em}
    .sheetStage .cur{font-size:12px; margin-inline-start:4px; opacity:.7; font-weight:900}



    .noScroll{overflow:hidden !important;}

    /* Focus pulse when jumping to a card */
    .pulseFocus{
      outline: 2px solid rgba(59,130,246,.55);
      box-shadow: 0 0 0 8px rgba(59,130,246,.14);
      transition: box-shadow .25s ease, outline-color .25s ease;
    }
</style>
</head>
<body>
  <header class="top">
    <div class="topInner">
      <div class="brand">
        <div class="mark" aria-hidden="true"></div>
        <div>
          <h1>Ù„ÙˆØ­Ø© Ø§Ù„ÙØ±ÙˆØ¹</h1>
          <p>Ø¹Ø±Ø¶ Ù…Ø¨Ø³Ù‘Ø· Ù„Ù„Ù…Ø¯Ø±Ø§Ø¡ â€¢ Ø¥Ø¯Ø§Ø±Ø© Ù…Ø±ÙƒØ²ÙŠØ© Ù„Ù„Ù…Ø±Ø§Ø­Ù„ ÙˆØ§Ù„Ù…Ø­ÙØ¸Ø©</p>
        </div>
      </div>

      <div class="seg" role="tablist" aria-label="mode">
        <button id="tabView" class="active" role="tab" aria-selected="true">Ø¹Ø±Ø¶</button>
        <button id="tabManage" role="tab" aria-selected="false">Ø¥Ø¯Ø§Ø±Ø©</button>
        <button id="tabSettings" role="tab" aria-selected="false">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
      </div>

      <div class="actions no-print">
        <button class="btn primary" id="btnAddSample">Ù…Ø«Ø§Ù„ Ø¬Ø§Ù‡Ø²</button>
        <button class="btn" id="btnPrint">Ø·Ø¨Ø§Ø¹Ø© / PDF</button>
        <button class="btn" id="btnExportImage">ØªØµØ¯ÙŠØ± ØµÙˆØ±Ø©</button>
        <button class="btn" id="btnExportImagesZip">ØªØµØ¯ÙŠØ± ØµÙˆØ± ZIP</button>
      </div>
    </div>
  </header>

  <!-- Mobile bottom navigation (keeps all existing controls; adds easier access on phones) -->
  <nav class="mNav no-print" aria-label="ØªÙ†Ù‚Ù„ Ø§Ù„Ù‡Ø§ØªÙ">
    <button class="mNavBtn" data-target="tabView" aria-label="Ø¹Ø±Ø¶">
      <span class="mI">ğŸ‘ï¸</span><span class="mT">Ø¹Ø±Ø¶</span>
    </button>
    <button class="mNavBtn" data-target="tabManage" aria-label="Ø¥Ø¯Ø§Ø±Ø©">
      <span class="mI">ğŸ› ï¸</span><span class="mT">Ø¥Ø¯Ø§Ø±Ø©</span>
    </button>
    <button class="mNavBtn" data-target="tabSettings" aria-label="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">
      <span class="mI">âš™ï¸</span><span class="mT">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
    </button>
    <span class="mSep" aria-hidden="true"></span>
    <button class="mNavBtn" data-action="print" aria-label="Ø·Ø¨Ø§Ø¹Ø© / PDF">
      <span class="mI">ğŸ–¨ï¸</span><span class="mT">PDF</span>
    </button>
    <button class="mNavBtn" data-action="images" aria-label="ØªØµØ¯ÙŠØ± ØµÙˆØ±">
      <span class="mI">ğŸ–¼ï¸</span><span class="mT">ØµÙˆØ±</span>
    </button>
  </nav>


  <main class="wrap">
    <section class="layout">
      <!-- LEFT: Cards -->
      <div class="panel" id="panelCards">
        <div class="panelHead">
          <div class="searchRow" style="flex:1">
            <input id="search" class="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…Ø¹..." />
            <span class="chip" id="countChip">0 Ø¨Ø·Ø§Ù‚Ø©</span>
          </div>
          <div class="actions no-print">
            <button class="btn small" id="btnFocus">ØªØ±ÙƒÙŠØ²</button>
            <button class="btn small ghost" id="btnHow">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„</button>
          </div>
        </div>
        <div class="list" id="cardList"></div>
      </div>

      <!-- RIGHT: Inspector / Manage / Settings -->
      <div class="panel inspector" id="panelRight">
        <!-- View inspector -->
        <div id="viewPane">
          <div class="hero">
            <h2 id="heroTitle">Ø§Ø®ØªØ± Ù…Ø¬Ù…Ø¹Ù‹Ø§</h2>
            <p id="heroSub">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¨Ø·Ø§Ù‚Ø© Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù‡Ù†Ø§.</p>
          </div>

          <div class="big" id="bigTiles" style="display:none">
            <div class="tile">
              <div class="t">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</div>
              <div class="v" id="vTotal">â€”</div>
              <div class="s" id="sStudents">â€”</div>
            </div>

            <div class="tile">
              <div class="t">Ø§Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
              <div class="v" id="vCovered">â€”</div>
              <div class="s" id="sCoveredNote">â€”</div>
            </div>

            <div class="tile">
              <div class="t">Ù‡Ø¯Ù Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ©</div>
              <div class="v" id="vGoal">â€”</div>
              <div class="s" id="sGoalNote">â€”</div>
            </div>

            <div class="tile">
              <div class="t">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¢Ù† ÙˆØ®Ø·Ø© Ø§Ù„Ù…Ø±Ø§Ø­Ù„</div>
              <div class="barWrap">
                <div class="bar" id="bigBar"></div>
                <div class="legend" id="bigLegend"></div>
              </div>
              <div class="s" id="sAfterPlan">â€”</div>
            </div>
          </div>

          <div class="panelBody" id="stageBlock" style="display:none; padding-top:0">
            <b style="display:block; font-size:13px; font-weight:1000; margin:10px 2px 10px;">Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ù…Ø±Ø§Ø­Ù„</b>
            <div class="stageGrid" id="stageGrid"></div>
          </div>
        </div>

        <!-- Manage pane -->
        <div id="managePane" style="display:none">
          <div class="panelHead">
            <b>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</b>
            <div class="actions no-print">
              <button class="btn small" id="btnAddRow">Ø¥Ø¶Ø§ÙØ© ØµÙ</button>
              <button class="btn small danger" id="btnClear">Ù…Ø³Ø­</button>
            </div>
          </div>
          <div class="panelBody">
            <div class="note">
              <b>Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø±ÙŠØ¹ (Ù„ØµÙ‚):</b> Ø§Ù†Ø³Ø® Ù…Ù† Google Sheets/Excel ÙˆØ§Ù„ØµÙ‚ Ù‡Ù†Ø§ (CSV Ø£Ùˆ TSV).<br>
              Ø§Ù„ØªØ±ØªÙŠØ¨: <code>Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…Ø¹</code> â€” <code>Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</code> â€” <code>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</code> â€” <code>Ù†Ø³Ø¨Ø© Ø§Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© %</code> (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) â€” <code>Ù…Ø¨Ù„Øº Ø§Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</code> (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            </div>

            <div class="form">
              <div class="field" style="grid-column:1/-1">
                <label>Ù„ØµÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</label>
                <textarea id="paste" placeholder="Ù…Ø«Ø§Ù„:
Ù…Ø¬Ù…Ø¹ Ø²ÙŠØ¯ Ø¨Ù† Ø«Ø§Ø¨Øª	123234	420	37
Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¥Ù…Ø§Ù… Ø¹Ø§ØµÙ…	310000	980		115000"></textarea>
              </div>
            </div>

            <div class="actions no-print" style="margin-top:10px">
              <button class="btn primary" id="btnApplyPaste">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù„ØµÙ‚</button>
              <button class="btn" id="btnExportJSON">ØªØµØ¯ÙŠØ± JSON</button>
              <button class="btn" id="btnImportJSON">Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
              <input id="jsonFile" type="file" accept="application/json" style="display:none" />
            </div>

            <div class="tableWrap">
              <table>
                <thead>
                  <tr>
                    <th style="min-width:260px">Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…Ø¹</th>
                    <th style="min-width:160px">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</th>
                    <th style="min-width:120px">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</th>
                    <th style="min-width:160px">Ù†Ø³Ø¨Ø© Ø§Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© %</th>
                    <th style="min-width:180px">Ù…Ø¨Ù„Øº Ø§Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</th>
                    <th style="min-width:90px">Ø­Ø°Ù</th>
                  </tr>
                </thead>
                <tbody id="rows"></tbody>
              </table>
            </div>

            <div class="stageBuilder">
              <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                <b style="font-size:13px; font-weight:1000">Ø§Ù„Ù…Ø±Ø§Ø­Ù„ (Ù…Ø±ÙƒØ²ÙŠØ©)</b>
                <div class="actions no-print">
                  <button class="btn small" id="btnAddStage">+ Ø¥Ø¶Ø§ÙØ©</button>
                  <button class="btn small ghost" id="btnResetStages">Ø§ÙØªØ±Ø§Ø¶ÙŠ</button>
                </div>
              </div>
              <div class="note" style="margin-top:10px">
                Ù„ÙƒÙ„ Ù…Ø±Ø­Ù„Ø©: Ø§Ø³Ù… + ÙØªØ±Ø© + <b>Ù†Ø³Ø¨Ø© ØªØºØ·ÙŠØ© Ù…Ø³ØªÙ‡Ø¯ÙØ© (ØªØ±Ø§ÙƒÙ…ÙŠØ© %)</b>.
                Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ø§ ØªÙØ¹Ø±Ø¶ Ù„Ù„Ù…Ø¯Ø±Ø§Ø¡ â€” ØªÙØ³ØªØ®Ø¯Ù… ÙÙ‚Ø· Ù„Ø­Ø³Ø§Ø¨ Ù‡Ø¯Ù Ø§Ù„Ù…Ø±Ø­Ù„Ø©.
              </div>
              <div id="stageList"></div>
            </div>
          </div>
        </div>

        <!-- Settings pane -->
        <div id="settingsPane" style="display:none">
          <div class="panelHead">
            <b>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø±ÙƒØ²ÙŠØ©</b>
            <div class="actions no-print">
              <button class="btn small" id="btnExportCSS">ØªØµØ¯ÙŠØ± CSS</button>
              <button class="btn small ghost" id="btnResetAll">Ø¥Ø±Ø¬Ø§Ø¹ ÙƒÙ„ Ø´ÙŠØ¡</button>
            </div>
          </div>
          <div class="panelBody">
            <div class="note">
              <b>Ø§Ù„Ù…Ø¨Ø¯Ø£:</b> Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠØ±Ù‰ â€œØ§Ù„Ù†ØªÙŠØ¬Ø©â€ ÙˆØ£Ù†Øª ØªØªØ­ÙƒÙ… Ø¨Ù€ â€œØ§Ù„Ù‚ÙˆØ§Ø¹Ø¯â€.<br>
              Ù‡Ø¯Ù Ø§Ù„Ù…Ø­ÙØ¸Ø© ÙŠÙØ­Ø³Ø¨ = Ù…Ø¨Ù„Øº Ø§Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ã· (Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ø³Ù†ÙˆÙŠ).
            </div>

            <div class="form">
              <div class="field">
                <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ø³Ù†ÙˆÙŠ (%)</label>
                <input id="returnRate" type="number" min="0" step="0.1" value="9">
              </div>
              <div class="field">
                <label>Ù‡Ø¯Ù Ø§Ù„Ù…Ø­ÙØ¸Ø© ÙŠØºØ·ÙŠ</label>
                <select id="goalScope">
                  <option value="remaining" selected>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</option>
                  <option value="total">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</option>
                </select>
              </div>
              <div class="field" style="grid-column:1/-1">
                <label>Ø¥Ø¸Ù‡Ø§Ø± ÙÙŠ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙŠØ³Ø§Ø±</label>
                <select id="leftDensity">
                  <option value="calm" selected>Ù‡Ø§Ø¯Ø¦ (Ù…Ø®ØªØµØ±)</option>
                  <option value="rich">ØºÙ†ÙŠ (ØªÙØ§ØµÙŠÙ„ Ø£ÙƒØ«Ø±)</option>
                </select>
              
            <div class="note" style="margin-top:12px">
              <b>Ù…Ø²Ø§Ù…Ù†Ø© Ø¬Ù…Ø§Ø¹ÙŠØ© (ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø¬Ù…ÙŠØ¹):</b> Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ù…Ù„Ù JSON Ø¹Ø§Ù… (GET) Ù„ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø£Ø­Ø¯Ø« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.
              ÙŠÙ…ÙƒÙ†Ùƒ Ø£ÙŠØ¶Ù‹Ø§ ÙˆØ¶Ø¹ Ø±Ø§Ø¨Ø· Ø­ÙØ¸ (POST) Ø¥Ù† ÙƒØ§Ù† Ù„Ø¯ÙŠÙƒ API ÙÙŠ Ù…Ù†ØµØªÙƒ Ù„Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©.
            </div>

            <div class="form">
              <div class="field" style="grid-column:1/-1">
                <label>Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON GET)</label>
                <input id="remoteGetUrl" type="url" placeholder="Ù…Ø«Ø§Ù„: https://yourdomain.com/data/compounds_data.json">
              </div>

              <div class="field">
                <label>ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ</label>
                <select id="remoteAutoOn">
                  <option value="on" selected>Ù…ÙØ¹Ù„</option>
                  <option value="off">Ù…ØªÙˆÙ‚Ù</option>
                </select>
              </div>

              <div class="field">
                <label>ÙƒÙ„ ÙƒÙ… Ø«Ø§Ù†ÙŠØ© ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«ØŸ</label>
                <input id="remoteInterval" type="number" min="5" step="1" value="20">
              </div>

              <div class="field" style="grid-column:1/-1">
                <label>Ø±Ø§Ø¨Ø· Ø§Ù„Ø­ÙØ¸ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ POST)</label>
                <input id="remotePushUrl" type="url" placeholder="Ù…Ø«Ø§Ù„: https://yourdomain.com/api/compounds/save">
              </div>

              <div class="field" style="grid-column:1/-1">
                <label>Token (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) â€” ÙŠÙˆØ¶Ø¹ ÙÙŠ Authorization: Bearer</label>
                <input id="remoteToken" type="password" placeholder="Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºÙ‹Ø§ Ø¥Ø°Ø§ Ù„Ø§ ÙŠÙˆØ¬Ø¯">
              </div>
            </div>

            <div class="actions no-print" style="margin-top:10px">
              <button class="btn primary" id="btnFetchRemote">Ø¬Ù„Ø¨ Ø£Ø­Ø¯Ø« Ù†Ø³Ø®Ø©</button>
              <button class="btn" id="btnPublishRemote">Ù†Ø´Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ø¬Ù…ÙŠØ¹</button>
              <span class="chip" id="syncState">ØºÙŠØ± Ù…ØªØµÙ„</span>
            </div>
</div>
            </div>

            <div class="note" style="margin-top:12px">
              <b>ØªØµØ¯ÙŠØ±/Ù…Ø´Ø§Ø±ÙƒØ©:</b> Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± <b>Ø·Ø¨Ø§Ø¹Ø© / PDF</b> Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ (ÙŠØªÙˆØ§ÙÙ‚ Ù…Ø¹ iOS) Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØµÙØ­Ø© ÙƒØ§Ù…Ù„Ø© Ø£Ùˆ Ø­ÙØ¸Ù‡Ø§ PDF.
            </div>
          </div>
        </div>

      </div>
    </section>
  </main>

  
  <!-- Export overlay -->
  <div id="exportOverlay" style="display:none; position:fixed; inset:0; z-index:9999; background:rgba(15,23,42,.55); backdrop-filter: blur(10px); padding:14px;">
    <div style="max-width:520px; margin:0 auto; background:rgba(255,255,255,.92); border:1px solid rgba(255,255,255,.28); border-radius:22px; box-shadow: 0 26px 72px rgba(16,24,40,.22); padding:14px;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
        <b style="font-size:13px; font-weight:1000; color:#0b1220">ØªØµØ¯ÙŠØ± Ø§Ù„ØµÙˆØ±</b>
        <button class="btn small danger" id="btnExportClose">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div id="exportStatus" style="margin-top:10px; font-size:12px; font-weight:900; color:rgba(11,18,32,.72); line-height:1.7">
        Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±â€¦
      </div>
      <div style="margin-top:10px; height:10px; background:rgba(11,18,32,.08); border-radius:999px; overflow:hidden; border:1px solid rgba(11,18,32,.08)">
        <div id="exportBar" style="height:100%; width:0%; background:linear-gradient(90deg, rgba(37,99,235,.85), rgba(16,185,129,.85)); border-radius:999px"></div>
      </div>
      <div style="margin-top:10px; font-size:11px; font-weight:900; color:rgba(11,18,32,.55)">
        Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· JSON Ø¹Ø§Ù… (GET). ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØµØ¯ÙŠØ± Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† (Ø£ÙØ¶Ù„) Ø£Ùˆ Ø£ÙˆÙÙ„Ø§ÙŠÙ† (Ø¨Ø¯ÙŠÙ„).
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script>
    // ===== Utilities =====
    const clamp=(v,a,b)=>Math.min(b,Math.max(a,v));
    const fmtSAR=(n)=>{
      if(n===null||n===undefined||Number.isNaN(n)) return "â€”";
      return Number(n).toLocaleString("ar-SA",{maximumFractionDigits:0})+" Ø±ÙŠØ§Ù„";
    };
    const fmtMoney=(n)=>{
      if(n===null||n===undefined||Number.isNaN(n)) return "â€”";
      return Number(n).toLocaleString("ar-SA",{maximumFractionDigits:0});
    };
    const fmtPct=(n)=>{
      if(n===null||n===undefined||Number.isNaN(n)) return "â€”";
      return Number(n).toLocaleString("ar-SA",{maximumFractionDigits:0})+"%";
    };

    function markDirty(){
      // Any local edit should bump updated timestamp (used for shared sync)
      localUpdatedAt = Date.now();
    }
    function parseNumber(v){
      if(v===null||v===undefined) return NaN;
      if(typeof v==="number") return v;
      const s=String(v).trim();
      if(!s) return NaN;
      const normalized=s.replace(/[Ù¬,]/g,"").replace(/Ø±ÙŠØ§Ù„|Ø±\.Ø³|SAR/gi,"").replace(/\s+/g,"");
      const n=Number(normalized);
      return Number.isFinite(n)?n:NaN;
    }
    function escapeHtml(s){
      return String(s??"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function uid(){ return Math.random().toString(16).slice(2)+Date.now().toString(16); }
    function safeFilename(name){ return (name||"data").toString().replace(/[\\/:*?"<>|]/g,"-").trim(); }
    function downloadBlob(filename, blob){
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a"); a.href=url; a.download=filename;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1500);
    }
    function detectDelimiter(line){
      const comma=(line.match(/,/g)||[]).length;
      const tab=(line.match(/\t/g)||[]).length;
      const semi=(line.match(/;/g)||[]).length;
      if(tab>=comma && tab>=semi && tab>0) return "\t";
      if(semi>comma) return ";";
      return ",";
    }
    function parseDelimited(text){
      const lines=(text||"").replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n").filter(l=>l.trim()!=="");
      if(!lines.length) return [];
      const delim=detectDelimiter(lines[0]);
      return lines.map(line=> line.split(delim).map(x=>String(x??"").trim()));
    }
    function stageColor(i){
      const palette=["var(--s1)","var(--s2)","var(--s3)","var(--s4)","var(--s5)","var(--s6)"];
      return palette[i % palette.length];
    }

    // ===== Elements =====
    const tabView = document.getElementById("tabView");
    const tabManage = document.getElementById("tabManage");
    const tabSettings = document.getElementById("tabSettings");

    const viewPane = document.getElementById("viewPane");
    const managePane = document.getElementById("managePane");
    const settingsPane = document.getElementById("settingsPane");

    const elSearch = document.getElementById("search");
    const elCountChip = document.getElementById("countChip");
    const elList = document.getElementById("cardList");

    const heroTitle = document.getElementById("heroTitle");
    const heroSub = document.getElementById("heroSub");
    const bigTiles = document.getElementById("bigTiles");
    const stageBlock = document.getElementById("stageBlock");

    const vTotal = document.getElementById("vTotal");
    const sStudents = document.getElementById("sStudents");

    const vCovered = document.getElementById("vCovered");
    const sCoveredNote = document.getElementById("sCoveredNote");

    const vGoal = document.getElementById("vGoal");
    const sGoalNote = document.getElementById("sGoalNote");

    const bigBar = document.getElementById("bigBar");
    const bigLegend = document.getElementById("bigLegend");
    const sAfterPlan = document.getElementById("sAfterPlan");

    const stageGrid = document.getElementById("stageGrid");

    // Manage
    const paste = document.getElementById("paste");
    const rowsTbody = document.getElementById("rows");
    const stageList = document.getElementById("stageList");

    // Settings
    const returnRate = document.getElementById("returnRate");
    const goalScope = document.getElementById("goalScope");
    const leftDensity = document.getElementById("leftDensity");

    // Sync (shared data)
    const remoteGetUrl = document.getElementById("remoteGetUrl");
    const remoteAutoOn = document.getElementById("remoteAutoOn");
    const remoteInterval = document.getElementById("remoteInterval");
    const remotePushUrl = document.getElementById("remotePushUrl");
    const remoteToken = document.getElementById("remoteToken");
    const btnFetchRemote = document.getElementById("btnFetchRemote");
    const btnPublishRemote = document.getElementById("btnPublishRemote");
    const syncState = document.getElementById("syncState");

    // Buttons
    document.getElementById("btnPrint").addEventListener("click", ()=>window.print());

    // ===== Export images (selected / ZIP) =====
    const exportOverlay = document.getElementById("exportOverlay");
    const exportStatus = document.getElementById("exportStatus");
    const exportBar = document.getElementById("exportBar");
    const btnExportClose = document.getElementById("btnExportClose");
    const btnExportImage = document.getElementById("btnExportImage");
    const btnExportImagesZip = document.getElementById("btnExportImagesZip");

    function showExport(msg, p){
      exportStatus.textContent = msg || "â€¦";
      exportBar.style.width = `${clamp(Number(p||0),0,100)}%`;
      exportOverlay.style.display = "block";
    }
    function hideExport(){ exportOverlay.style.display = "none"; }

    btnExportClose?.addEventListener("click", hideExport);

    async function ensureExportLibs(){
      // Keep the original html2canvas path if available, but allow an offline fallback.
      // If html2canvas is missing (no internet / blocked CDN), we will use an offline SVG renderer.
      return true;
    }

    function buildInspectorSnapshotNode(){
      // Snapshot is based on the View inspector only (clean, manager-friendly)
      const root = document.createElement("div");
      root.dir = "rtl";
      root.lang = "ar";
      root.className = "arabicFixSnapshot";
      root.style.background = "#fff";
      root.style.padding = "14px";
      root.style.width = "1100px";
      root.style.maxWidth = "1100px";
      // Strong Arabic-safe font fallback chain (prevents disjoint letters in some render paths)
      root.style.fontFamily = `"IBM Plex Sans Arabic","Noto Naskh Arabic","Noto Sans Arabic","Geeza Pro","Tahoma","Arial",sans-serif`;
      root.style.direction = "rtl";
      root.style.unicodeBidi = "plaintext";
      root.style.letterSpacing = "normal";

      // Clone just the inspector view (hero + tiles + stages)
      const view = document.getElementById("viewPane");
      const clone = view.cloneNode(true);

      // Remove any no-print elements inside snapshot (none expected)
      clone.querySelectorAll(".no-print, .seg, .actions").forEach(n=>n.remove());

      // Force visibility of tiles if hidden (when no selection)
      const bt = clone.querySelector("#bigTiles");
      const sb = clone.querySelector("#stageBlock");
      if(bt) bt.style.display = "";
      if(sb) sb.style.display = "";

      // Make it look like a single page (no sticky/scroll)
      clone.style.display = "";
      root.appendChild(clone);

      // Apply current styles by cloning the CSS (keeps styling identical in the temp snapshot)
      const styleEl = document.getElementById("appCSS");
      if(styleEl){
        const style = document.createElement("style");
        style.textContent = styleEl.textContent || "";
        root.prepend(style);
      }

      // Extra CSS fixes for Arabic shaping/ligatures in export capture
      const fix = document.createElement("style");
      fix.textContent = `
        .arabicFixSnapshot, .arabicFixSnapshot *{
          direction: rtl !important;
          unicode-bidi: plaintext !important;
          font-family: "IBM Plex Sans Arabic","Noto Naskh Arabic","Noto Sans Arabic","Geeza Pro","Tahoma","Arial",sans-serif !important;
          -webkit-text-size-adjust: 100%;
          font-kerning: normal;
          text-rendering: geometricPrecision;
        }
      `;
      root.prepend(fix);

      return root;
    }

    async function renderSnapshotCanvas(){
      // Create temp container (inside same document so fonts are already available)
      const temp = document.createElement("div");
      temp.style.position="fixed";
      temp.style.inset="0";
      temp.style.zIndex="9998";
      temp.style.background="#fff";
      temp.style.overflow="auto";
      temp.style.padding="10px";
      const node = buildInspectorSnapshotNode();
      temp.appendChild(node);
      document.body.appendChild(temp);

      try{
        // Ensure web fonts are ready before capture (prevents Arabic letter disjoint in some cases)
        if(document.fonts && document.fonts.ready){
          await document.fonts.ready;
        }
        

    // ===== Offline fallback renderer (no external libs) =====
    function nodeToSvgData(node, width, height){
      // Wrap HTML in SVG foreignObject (offline rasterization path)
      const serializer = new XMLSerializer();
      const xhtml = document.createElement("div");
      xhtml.setAttribute("xmlns", "http://www.w3.org/1999/xhtml");
      xhtml.style.width = width + "px";
      xhtml.style.height = height + "px";
      xhtml.style.background = "#fff";
      xhtml.appendChild(node);

      const htmlStr = serializer.serializeToString(xhtml);
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}">
          <foreignObject x="0" y="0" width="100%" height="100%">
            ${htmlStr}
          </foreignObject>
        </svg>
      `.trim();
      return svg;
    }

    async function renderSnapshotCanvasOffline(){
      // Create temp container to measure layout precisely
      const temp = document.createElement("div");
      temp.style.position = "fixed";
      temp.style.left = "-10000px";
      temp.style.top = "0";
      temp.style.width = "1100px";
      temp.style.background = "#fff";
      temp.style.zIndex = "9998";
      temp.style.pointerEvents = "none";

      const node = buildInspectorSnapshotNode();
      temp.appendChild(node);
      document.body.appendChild(temp);

      try{
        if(document.fonts && document.fonts.ready){
          await document.fonts.ready;
        }
        await new Promise(r=>setTimeout(r, 120));
        await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));

        const rect = node.getBoundingClientRect();
        const w = Math.max(1, Math.ceil(rect.width));
        const h = Math.max(1, Math.ceil(rect.height));

        const svgStr = nodeToSvgData(node, w, h);
        const blob = new Blob([svgStr], {type:"image/svg+xml;charset=utf-8"});
        const url = URL.createObjectURL(blob);

        try{
          const img = new Image();
          img.decoding = "sync";
          const loaded = new Promise((resolve, reject)=>{
            img.onload = resolve;
            img.onerror = reject;
          });
          img.src = url;
          await loaded;

          const scale = 2;
          const canvas = document.createElement("canvas");
          canvas.width = Math.round(w * scale);
          canvas.height = Math.round(h * scale);
          const ctx = canvas.getContext("2d");
          ctx.setTransform(scale,0,0,scale,0,0);
          ctx.imageSmoothingEnabled = true;
          ctx.imageSmoothingQuality = "high";
          ctx.fillStyle = "#fff";
          ctx.fillRect(0,0,w,h);
          ctx.drawImage(img, 0, 0);
          return canvas;
        } finally {
          URL.revokeObjectURL(url);
        }
      } finally {
        temp.remove();
      }
    }

    async function renderSnapshotCanvasSmart(){
      // Prefer html2canvas if available; otherwise offline fallback
      if(typeof html2canvas === "function"){
        return await renderSnapshotCanvas();
      }
      return await renderSnapshotCanvasOffline();
    }
// Give Safari/iOS a moment to apply shaping after font swap
        await new Promise(r=>setTimeout(r, 120));
        await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));

        const opts = {scale: 2, backgroundColor:"#ffffff", useCORS:true, letterRendering:true, foreignObjectRendering:true};
        try{
          const canvas = await html2canvas(node, opts);
          return canvas;
        }catch(e){
          // Fallback path (some browsers dislike foreignObjectRendering)
          const canvas = await html2canvas(node, {...opts, foreignObjectRendering:false});
          return canvas;
        }
      } finally {
        temp.remove();
      }
    }

    async function exportSelectedImage(){
      if(!selectedId){
        alert("Ø§Ø®ØªØ± Ù…Ø¬Ù…Ø¹Ù‹Ø§ Ø£ÙˆÙ„Ù‹Ø§.");
        return;
      }
      if(!await ensureExportLibs()) return;

      showExport("Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØµÙˆØ±Ø©â€¦", 12);
      try{
        const canvas = await renderSnapshotCanvasSmart();
        showExport("Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©â€¦", 70);
        const blob = await new Promise(res=>canvas.toBlob(res, "image/png"));
        const name = safeFilename(cards.find(c=>c.id===selectedId)?.branch_name || "compound");
        downloadBlob(`Ø¨Ø·Ø§Ù‚Ø©_${name}.png`, blob);
        showExport("ØªÙ… âœ…", 100);
        setTimeout(hideExport, 650);
      } catch(e){
        hideExport();
        alert("ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± Ø§Ù„ØµÙˆØ±Ø©.");
      }
    }

    async function exportAllImagesZip(){
      if(!cards.length){
        alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª.");
        return;
      }
      if(!await ensureExportLibs()) return;
      const hasZip = (typeof JSZip === "function");

      showExport("Ø¨Ø¯Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ±â€¦", 2);
      const zip = hasZip ? new JSZip() : null;

      try{
        for(let i=0;i<cards.length;i++){
          const c = cards[i];
          // select and render
          selectedId = c.id;
          renderCards();

      // Open a card directly if URL hash includes #card=<id>
      const hid = getCardHash();
      if(hid && cards.some(c=>c.id===hid)){
        selectCard(hid);
        focusCardInList(hid);
      }
          selectCard(c.id);
          await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));

          showExport(`ØªØµØ¯ÙŠØ±: ${c.branch_name} (${i+1}/${cards.length})`, (i/cards.length)*70 + 10);

          const canvas = await renderSnapshotCanvasSmart();
          const blob = await new Promise(res=>canvas.toBlob(res, "image/png"));
          const arr = await blob.arrayBuffer();
          if(zip){
            zip.file(`Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª/Ø¨Ø·Ø§Ù‚Ø©_${safeFilename(c.branch_name)}.png`, arr);
          } else {
            // Offline fallback: download each image separately
            downloadBlob(`Ø¨Ø·Ø§Ù‚Ø©_${safeFilename(c.branch_name)}.png`, blob);
          }
        }

        if(zip){
          showExport("ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„Ùâ€¦", 92);
          const out = await zip.generateAsync({type:"blob"});
          downloadBlob("Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª_ØµÙˆØ±.zip", out);
        }
        showExport("ØªÙ… âœ…", 100);
        setTimeout(hideExport, 700);
      } catch(e){
        hideExport();
        alert("ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± Ø§Ù„ØµÙˆØ± ÙƒÙ…Ù„Ù ZIP.");
      } finally {
        save();
      }
    }

    document.getElementById("btnHow").addEventListener("click", ()=>{
      alert("Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù…Ù† ØªØ¨ÙˆÙŠØ¨ (Ø¥Ø¯Ø§Ø±Ø©): Ù„ØµÙ‚ Ù…Ù† Google Sheets/Excel Ø«Ù… (ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù„ØµÙ‚).");
    });
    btnExportImage?.addEventListener("click", exportSelectedImage);
    btnExportImagesZip?.addEventListener("click", exportAllImagesZip);

    document.getElementById("btnFocus").addEventListener("click", ()=>{
      document.getElementById("panelRight").scrollIntoView({behavior:"smooth", block:"start"});
    });

    // ===== State =====
    const LS="compound_kanso_v1";
    let cards=[];
    let stages=[];
    let selectedId=null;

    // Shared sync meta
    let localUpdatedAt = 0;
    let syncTimer = null;

    function defaultStages(){
      return [
        {id:uid(), name:"Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰", period:"Ø®Ù„Ø§Ù„ Ø±Ù…Ø¶Ø§Ù†", target_pct:65},
        {id:uid(), name:"Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©", period:"Ø¨Ø¹Ø¯ Ø±Ù…Ø¶Ø§Ù†", target_pct:80},
        {id:uid(), name:"Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©", period:"Ù†ØµÙ Ø§Ù„Ø³Ù†Ø©", target_pct:90},
        {id:uid(), name:"Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©", period:"Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø³Ù†Ø©", target_pct:100},
      ];
    }

    function normalizeCard(obj, id){
      const total=parseNumber(obj.total_cost);
      const students=parseNumber(obj.students);
      let curAmt=parseNumber(obj.covered_current_amount);
      const curPctIn=parseNumber(obj.covered_current_pct);

      const T = Number.isFinite(total)? total : 0;
      if(!Number.isFinite(curAmt)){
        curAmt = (Number.isFinite(curPctIn) && T>0) ? T * clamp(curPctIn,0,100)/100 : 0;
      }
      const curPct = (T>0) ? (curAmt/T*100) : 0;

      return {
        id,
        branch_name:(obj.branch_name??"").toString().trim(),
        total_cost:T,
        students: Number.isFinite(students)? students : 0,
        covered_current_amount: clamp(curAmt,0,T),
        covered_current_pct: clamp(curPct,0,100),
      };
    }

    function calcPortfolioGoal(total, coveredAmt){
      const ratePct=parseNumber(returnRate.value);
      const rate = Number.isFinite(ratePct) ? ratePct/100 : 0;
      const scope = goalScope.value;
      const amountToCover = scope==="total" ? Math.max(0,total) : Math.max(0,total - coveredAmt);
      if(rate<=0) return {goal: NaN, amountToCover, rate};
      return {goal: amountToCover / rate, amountToCover, rate};
    }
    function stageGoal(coverAmount, rate){
      if(!rate || rate<=0) return NaN;
      return Math.max(0, coverAmount) / rate;
    }

    function computeStagePlan(card){
      const total=card.total_cost||0;
      const coveredNow=clamp(card.covered_current_amount||0, 0, total);
      const {rate} = calcPortfolioGoal(total, coveredNow);

      const sorted = stages
        .map((s,i)=>({ ...s, t: clamp(parseNumber(s.target_pct),0,100)}))
        .sort((a,b)=>a.t-b.t);

      let current=coveredNow;
      const plans = sorted.map((s, idx)=>{
        const desired = total * (s.t/100);
        const inc = Math.max(0, Math.min(total, desired) - current);
        current += inc;
        return {
          name:(s.name??`Ù…Ø±Ø­Ù„Ø© ${idx+1}`).toString(),
          period:(s.period??"").toString(),
          incrementAmount: inc,
          goal: stageGoal(inc, rate),
          color: stageColor(idx),
        };
      });

      const afterCovered = Math.min(total, current);
      const remain = Math.max(0, total - afterCovered);
      return {total, coveredNow, plans, afterCovered, remain, rate};
    }

    // ===== Persistence =====
    function save(){
      // bump updated timestamp on any local change
      if(!localUpdatedAt) localUpdatedAt = Date.now();
      const data={
        meta:{ updated_at: localUpdatedAt, schema: 1 },
        settings:{
          returnRate: returnRate.value,
          goalScope: goalScope.value,
          leftDensity: leftDensity.value,
          remoteGetUrl: remoteGetUrl?.value || "",
          remoteAutoOn: remoteAutoOn?.value || "on",
          remoteInterval: remoteInterval?.value || "20",
          remotePushUrl: remotePushUrl?.value || "",
          remoteToken: remoteToken?.value || ""
        },
        cards, stages, selectedId
      };
      localStorage.setItem(LS, JSON.stringify(data));
    }
    function load(){
      try{
        const raw=localStorage.getItem(LS);
        if(!raw) return false;
        const d=JSON.parse(raw);
        if(d?.meta?.updated_at) localUpdatedAt = Number(d.meta.updated_at)||0;
        if(d?.settings){
          if(d.settings.returnRate!=null) returnRate.value=d.settings.returnRate;
          if(d.settings.goalScope!=null) goalScope.value=d.settings.goalScope;
          if(d.settings.leftDensity!=null) leftDensity.value=d.settings.leftDensity;

          if(remoteGetUrl && d.settings.remoteGetUrl!=null) remoteGetUrl.value=d.settings.remoteGetUrl;
          if(remoteAutoOn && d.settings.remoteAutoOn!=null) remoteAutoOn.value=d.settings.remoteAutoOn;
          if(remoteInterval && d.settings.remoteInterval!=null) remoteInterval.value=d.settings.remoteInterval;
          if(remotePushUrl && d.settings.remotePushUrl!=null) remotePushUrl.value=d.settings.remotePushUrl;
          if(remoteToken && d.settings.remoteToken!=null) remoteToken.value=d.settings.remoteToken;
        }
        if(Array.isArray(d.cards)) cards=d.cards;
        if(Array.isArray(d.stages)) stages=d.stages;
        if(d.selectedId) selectedId=d.selectedId;
        return true;
      }catch(e){ return false; }
    }

    // ===== Render cards =====
    function renderCards(){
      const q=(elSearch.value||"").trim().toLowerCase();
      const list=cards.filter(c=>!q || c.branch_name.toLowerCase().includes(q));
      elList.innerHTML="";
      list.forEach(c=> elList.appendChild(renderCardMini(c)));
      elCountChip.textContent = `${list.length} Ø¨Ø·Ø§Ù‚Ø©`;
    }

    function renderCardMini(c){
      const plan=computeStagePlan(c);
      const total=plan.total;
      const pct=(amt)=> total>0 ? (amt/total*100) : 0;

      const stageSum=plan.plans.reduce((a,p)=>a+p.incrementAmount,0);
      const barSegs=[
        {amount: plan.coveredNow, color:"rgba(247,168,163,1)"},
        ...plan.plans.map(p=>({amount:p.incrementAmount, color:p.color})),
        {amount: plan.remain, color:"#e5e7eb"}
      ].filter(s=>s.amount>0.0001);

      const dense = (leftDensity.value==="rich");

      const el=document.createElement("div");
      el.className="card"+(c.id===selectedId?" selected":"");
      el.setAttribute("role","button");
      el.setAttribute("tabindex","0");
      el.addEventListener("click", ()=>selectCard(c.id, true));
      el.addEventListener("keydown",(e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); selectCard(c.id, true);} });

      el.innerHTML=`
        <div class="cardTop">
          <h3 class="name">${escapeHtml(c.branch_name||"â€”")}</h3>
          <div class="kpi">
            <div class="l">Ø§Ù„ØªÙƒÙ„ÙØ©</div>
            <div class="v"><strong>${fmtMoney(total)}</strong></div>
          </div>
        </div>
        <div class="meta">
          <span class="pill"><span>Ø·Ù„Ø§Ø¨</span>${Number(c.students||0).toLocaleString("ar-SA")}</span>
          <span class="pill"><span>ØªØºØ·ÙŠØ©</span>${fmtPct(c.covered_current_pct)}</span>
          ${dense ? `<span class="pill"><span>Ø­Ø§Ù„ÙŠ</span>${fmtMoney(plan.coveredNow)}</span>` : ``}
        </div>
        <div class="barWrap">
          <div class="bar">
            ${barSegs.map(s=>`<div class="segm" style="width:${pct(s.amount)}%; background:${s.color}"></div>`).join("")}
          </div>
          ${dense ? `
            <div class="legend">
              <span class="leg"><span class="dot" style="background:rgba(247,168,163,1)"></span>Ø§Ù„Ø­Ø§Ù„ÙŠ</span>
              <span class="leg"><span class="dot" style="background:#111827"></span>Ø§Ù„Ù…Ø±Ø§Ø­Ù„</span>
              <span class="leg"><span class="dot" style="background:#e5e7eb"></span>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</span>
            </div>
          ` : ``}
        </div>
      `;
      return el;
    }

    // ===== Inspector =====
    function selectCard(id, openSheet=false){
      selectedId=id;
      renderCards();
      const c=cards.find(x=>x.id===id);
      if(!c) return;

      const plan=computeStagePlan(c);
      const total=plan.total;
      const stageSum=plan.plans.reduce((a,p)=>a+p.incrementAmount,0);

      heroTitle.textContent = c.branch_name || "â€”";
      heroSub.textContent = "Ù…Ù„Ø®Øµ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ø±Ø¶: Ø§Ù„ØªÙƒÙ„ÙØ©ØŒ Ø§Ù„ØªØºØ·ÙŠØ©ØŒ Ø§Ù„Ù…Ø­ÙØ¸Ø©ØŒ Ø«Ù… Ø§Ù„Ù…Ø±Ø§Ø­Ù„.";

      bigTiles.style.display="";
      stageBlock.style.display="";

      vTotal.textContent = fmtSAR(total);
      sStudents.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨: ${Number(c.students||0).toLocaleString("ar-SA")}`;

      vCovered.textContent = `${fmtPct(c.covered_current_pct)}  â€¢  ${fmtSAR(plan.coveredNow)}`;
      sCoveredNote.textContent = `ØªØºØ·ÙŠØ© Ø§Ù„Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ù† Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©.`;

      const {goal, amountToCover, rate} = calcPortfolioGoal(total, plan.coveredNow);
      vGoal.textContent = fmtSAR(goal);
      const scopeText = (goalScope.value==="total") ? "Ù„ØªØºØ·ÙŠØ© Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©" : "Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©";
      sGoalNote.textContent = `${scopeText} Ø¹Ù„Ù‰ Ø¹Ø§Ø¦Ø¯ Ø³Ù†ÙˆÙŠ ${fmtPct(parseNumber(returnRate.value))} (Ù…Ø¨Ù„Øº Ø§Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${fmtSAR(amountToCover)}).`;

      // Big progress
      const pct=(amt)=> total>0 ? (amt/total*100) : 0;
      const barSegs=[
        {amount: plan.coveredNow, color:"rgba(247,168,163,1)", label:`Ø§Ù„Ø­Ø§Ù„ÙŠ: ${fmtSAR(plan.coveredNow)}`},
        ...plan.plans.map(p=>({amount:p.incrementAmount, color:p.color, label:`${p.name}: ${fmtSAR(p.incrementAmount)}`})),
        {amount: plan.remain, color:"#e5e7eb", label:`Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${fmtSAR(plan.remain)}`}
      ].filter(s=>s.amount>0.0001);

      bigBar.innerHTML = barSegs.map(s=>`<div class="segm" style="width:${pct(s.amount)}%; background:${s.color}"></div>`).join("");
      bigLegend.innerHTML = `
        <span class="leg"><span class="dot" style="background:rgba(247,168,163,1)"></span>Ø§Ù„Ø­Ø§Ù„ÙŠ: ${fmtSAR(plan.coveredNow)}</span>
        <span class="leg"><span class="dot" style="background:#111827"></span>Ø§Ù„Ù…Ø±Ø§Ø­Ù„: ${fmtSAR(stageSum)}</span>
        <span class="leg"><span class="dot" style="background:#e5e7eb"></span>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${fmtSAR(plan.remain)}</span>
      `;
      const afterPct = total>0 ? (plan.afterCovered/total*100) : 0;
      sAfterPlan.textContent = `Ø¨Ø¹Ø¯ Ø®Ø·Ø© Ø§Ù„Ù…Ø±Ø§Ø­Ù„: ØªØµÙ„ Ø§Ù„ØªØºØ·ÙŠØ© Ø¥Ù„Ù‰ ${fmtPct(afterPct)}.`;

      // Stage tiles (goal prominent)
      stageGrid.innerHTML = plan.plans
        .filter(p=>p.incrementAmount>0.0001)
        .map((p, idx)=>`
          <div class="stage" style="--stageColor:${p.color}">
            <div class="row">
              <b>${escapeHtml(p.name)}</b>
              <span>${escapeHtml(p.period||"")}</span>
            </div>
            <div class="lbl">Ù‡Ø¯Ù Ø§Ù„Ù…Ø±Ø­Ù„Ø©</div>
            <div class="amt">${fmtMoney(p.goal)}<span class="cur">ï·¼</span></div>
          </div>
        `).join("") || `<div class="note" style="margin:0">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§Ø­Ù„ ÙØ¹Ù‘Ø§Ù„Ø© â€” Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ù…Ù† ØªØ¨ÙˆÙŠØ¨ (Ø¥Ø¯Ø§Ø±Ø©).</div>`;

      // Mobile sheet (avoid scrolling to bottom on phones)
      if(openSheet && isMobile()){
        renderSheetForCard(c, plan);
        openDetailSheet();
        syncSheetNav();
      }

      save();
    }
    // ===== Mobile sheet rendering (better UX for long lists) =====
    function isMobile(){
      return window.matchMedia && window.matchMedia("(max-width: 640px)").matches;
    }

    function openDetailSheet(){
      const sh = document.getElementById("detailSheet");
      const bd = document.getElementById("sheetBackdrop");
      if(!sh || !bd) return;
      sh.hidden = false; bd.hidden = false;
      requestAnimationFrame(()=> sh.classList.add("isOpen"));
      document.documentElement.classList.add("noScroll");
      document.body.classList.add("noScroll");
    }
    function closeDetailSheet(){
      const sh = document.getElementById("detailSheet");
      const bd = document.getElementById("sheetBackdrop");
      if(!sh || !bd) return;
      sh.classList.remove("isOpen");
      document.documentElement.classList.remove("noScroll");
      document.body.classList.remove("noScroll");
      setTimeout(()=>{ sh.hidden = true; bd.hidden = true; }, 180);
    }

    function currentFilteredIds(){
      const q=(elSearch.value||"").trim().toLowerCase();
      return cards
        .filter(c=>!q || (c.branch_name||"").toLowerCase().includes(q))
        .map(c=>c.id);
    }

    function renderSheetForCard(c, plan){
      const shName = document.getElementById("sheetName");
      const shBody = document.getElementById("sheetBody");
      if(!shBody) return;

      if(shName) shName.textContent = c.branch_name || "â€”";

      const total = plan.total;
      const stageSum = plan.plans.reduce((a,p)=>a+p.incrementAmount,0);
      const afterAmt = plan.coveredNow + stageSum;
      const afterPct = total>0 ? (afterAmt/total*100) : 0;
      const coveredPct = total>0 ? (plan.coveredNow/total*100) : 0;

      // Build progress segments (current + stages + remaining)
      const segs = [
        {amount: plan.coveredNow, color:"rgba(247,168,163,1)", label:"Ø§Ù„Ø­Ø§Ù„ÙŠ"},
        ...plan.plans.map(p=>({amount:p.incrementAmount, color:p.color, label:p.name})),
        {amount: plan.remain, color:"#e5e7eb", label:"Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ"}
      ].filter(s=>s.amount>0.0001);

      const segHtml = segs.map(s=>{
        const w = total>0 ? (s.amount/total*100) : 0;
        return `<span class="seg" style="width:${w}%; background:${s.color}"></span>`;
      }).join("");

      const legendSmall = `
        <div class="legend" style="margin-top:10px">
          <span class="leg"><span class="dot" style="background:rgba(247,168,163,1)"></span>Ø§Ù„Ø­Ø§Ù„ÙŠ</span>
          <span class="leg"><span class="dot" style="background:#111827"></span>Ø§Ù„Ù…Ø±Ø§Ø­Ù„</span>
          <span class="leg"><span class="dot" style="background:#e5e7eb"></span>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</span>
        </div>
      `;

      const stagesHtml = (plan.plans||[])
        .filter(p=>p.incrementAmount>0.0001)
        .map(p=>`
          <div class="sheetStage" style="outline:2px solid color-mix(in srgb, ${p.color} 28%, transparent); outline-offset:-2px">
            <div class="row">
              <b>${escapeHtml(p.name)}</b>
              <span style="color: rgba(11,18,32,.55); font-size:12px; font-weight:900">${escapeHtml(p.period||"")}</span>
            </div>
            <div class="lbl">Ù‡Ø¯Ù Ø§Ù„Ù…Ø±Ø­Ù„Ø©</div>
            <div class="amt">${fmtMoney(p.goal)}<span class="cur">ï·¼</span></div>
          </div>
        `).join("") || `<div class="note" style="margin:0">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§Ø­Ù„ ÙØ¹Ù‘Ø§Ù„Ø© â€” Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ù…Ù† ØªØ¨ÙˆÙŠØ¨ (Ø¥Ø¯Ø§Ø±Ø©).</div>`;

      shBody.innerHTML = `
        <div class="sheetCard">
          <div class="pad">
            <div class="sheetGrid">
              <div class="tile">
                <div class="t">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</div>
                <div class="v">${fmtMoney(total)} <span style="font-size:12px; opacity:.7; font-weight:900">ï·¼</span></div>
                <div class="s">${fmtNumber(c.students)} Ø·Ø§Ù„Ø¨/Ø·Ø§Ù„Ø¨Ø©</div>
              </div>
              <div class="tile">
                <div class="t">Ø§Ù„ØªØºØ·ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
                <div class="v">${fmtMoney(plan.coveredNow)} <span style="font-size:12px; opacity:.7; font-weight:900">ï·¼</span></div>
                <div class="s">${fmtPct(coveredPct)} Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
              </div>
              <div class="tile">
                <div class="t">Ù‡Ø¯Ù Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ©</div>
                <div class="v">${fmtMoney(plan.goal)} <span style="font-size:12px; opacity:.7; font-weight:900">ï·¼</span></div>
                <div class="s">Ù…Ø±ÙƒØ²ÙŠ (Ù†Ø³Ø¨Ø© Ø§Ù„ØªØºØ·ÙŠØ© + Ø§Ù„Ø¹Ø§Ø¦Ø¯)</div>
              </div>
              <div class="tile">
                <div class="t">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¢Ù† ÙˆØ®Ø·Ø© Ø§Ù„Ù…Ø±Ø§Ø­Ù„</div>
                <div class="barWrap" style="margin-top:10px">
                  <div class="bar">${segHtml}</div>
                  ${legendSmall}
                </div>
                <div class="s" style="margin-top:10px">Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø±Ø§Ø­Ù„: ${fmtMoney(afterAmt)} ï·¼ â€¢ ${fmtPct(afterPct)}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="sheetCard">
          <div class="pad">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px">
              <div style="font-weight:1000; color: rgba(11,18,32,.82)">Ø®Ø·Ø© Ø§Ù„Ù…Ø±Ø§Ø­Ù„</div>
              <div class="chip" style="padding:7px 10px">${(plan.plans||[]).filter(p=>p.incrementAmount>0.0001).length} Ù…Ø±Ø§Ø­Ù„</div>
            </div>
            <div class="sheetStages">${stagesHtml}</div>
          </div>
        </div>
      `;
    }

    function syncSheetNav(){
      const ids = currentFilteredIds();
      const i = ids.indexOf(selectedId);
      const prev = document.getElementById("sheetPrev");
      const next = document.getElementById("sheetNext");
      if(prev) prev.disabled = (i<=0);
      if(next) next.disabled = (i<0 || i>=ids.length-1);
    }

    function sheetGo(delta){
      const ids = currentFilteredIds();
      const i = ids.indexOf(selectedId);
      if(i<0) return;
      const j = i + delta;
      if(j<0 || j>=ids.length) return;
      selectCard(ids[j], true);
    }


    // ===== Manage table =====
    function renderRows(){
      rowsTbody.innerHTML="";
      cards.forEach((c, idx)=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td><input class="cell" data-i="${idx}" data-k="branch_name" value="${escapeHtml(c.branch_name)}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…Ø¹"/></td>
          <td><input class="cell" data-i="${idx}" data-k="total_cost" value="${c.total_cost||""}" placeholder="Ù…Ø«Ø§Ù„: 123000"/></td>
          <td><input class="cell" data-i="${idx}" data-k="students" value="${c.students||""}" placeholder="Ù…Ø«Ø§Ù„: 420"/></td>
          <td><input class="cell" data-i="${idx}" data-k="covered_current_pct" value="${Number.isFinite(c.covered_current_pct)? Math.round(c.covered_current_pct):""}" placeholder="Ù…Ø«Ø§Ù„: 37"/></td>
          <td><input class="cell" data-i="${idx}" data-k="covered_current_amount" value="${c.covered_current_amount||""}" placeholder="Ù…Ø«Ø§Ù„: 115000"/></td>
          <td><button class="btn small danger no-print" data-del="${idx}">Ø­Ø°Ù</button></td>
        `;
        rowsTbody.appendChild(tr);
      });

      rowsTbody.querySelectorAll("input.cell").forEach(inp=>{
        inp.addEventListener("input", ()=>{
          const i=Number(inp.getAttribute("data-i"));
          const k=inp.getAttribute("data-k");
          const obj={...cards[i]};
          obj[k]=inp.value;
          cards[i]=normalizeCard(obj, cards[i].id);
          markDirty(); save(); renderCards();
          if(selectedId===cards[i].id) selectCard(selectedId);
        });
      });

      rowsTbody.querySelectorAll("[data-del]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const i=Number(btn.getAttribute("data-del"));
          const removed=cards[i]?.id;
          cards.splice(i,1);
          if(selectedId===removed) selectedId=null;
          renderRows(); renderCards(); updateInspectorEmpty(); markDirty(); save();
        });
      });
    }

    function applyPaste(){
      const rows=parseDelimited(paste.value);
      if(!rows.length){ alert("Ø§Ù„ØµÙ‚ Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹."); return; }
      rows.forEach(r=>{
        const obj={
          branch_name:r[0]??"",
          total_cost:r[1]??"",
          students:r[2]??"",
          covered_current_pct:r[3]??"",
          covered_current_amount:r[4]??"",
        };
        const norm=normalizeCard(obj, uid());
        if(norm.branch_name) cards.push(norm);
      });
      paste.value="";
      renderRows(); renderCards();
      if(!selectedId && cards.length) selectCard(cards[0].id);
      save();
    }

    // ===== Stages builder =====
    function renderStages(){
      stageList.innerHTML="";
      stages.forEach((st, idx)=>{
        const color=stageColor(idx);
        const box=document.createElement("div");
        box.className="stageItem";
        box.innerHTML=`
          <div class="stageTop">
            <span class="badge"><span class="swatch" style="background:${color}"></span>#${idx+1}</span>
            <button class="btn small danger no-print" data-remove="${st.id}">Ø­Ø°Ù</button>
          </div>
          <div class="stageForm">
            <div class="field" style="margin:0">
              <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label>
              <input data-id="${st.id}" data-k="name" value="${escapeHtml(st.name)}"/>
            </div>
            <div class="field" style="margin:0">
              <label>Ø§Ù„ÙØªØ±Ø©</label>
              <input data-id="${st.id}" data-k="period" value="${escapeHtml(st.period)}"/>
            </div>
            <div class="field" style="margin:0">
              <label>Ù†Ø³Ø¨Ø© Ø§Ù„ØªØºØ·ÙŠØ© Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ© (%)</label>
              <input type="number" min="0" max="100" step="0.1" data-id="${st.id}" data-k="target_pct" value="${escapeHtml(st.target_pct)}"/>
            </div>
          </div>
        `;
        stageList.appendChild(box);
      });

      stageList.querySelectorAll("[data-remove]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id=b.getAttribute("data-remove");
          stages = stages.filter(x=>x.id!==id);
          renderStages(); markDirty(); save(); rerenderAll();
        });
      });
      stageList.querySelectorAll("input[data-id]").forEach(inp=>{
        inp.addEventListener("input", ()=>{
          const id=inp.getAttribute("data-id");
          const k=inp.getAttribute("data-k");
          const st=stages.find(x=>x.id===id);
          if(!st) return;
          st[k]=inp.value;
          markDirty(); save(); rerenderAll();
        });
      });
    }

    function updateInspectorEmpty(){
      if(selectedId && cards.some(c=>c.id===selectedId)) return;
      heroTitle.textContent="Ø§Ø®ØªØ± Ù…Ø¬Ù…Ø¹Ù‹Ø§";
      heroSub.textContent="Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¨Ø·Ø§Ù‚Ø© Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù‡Ù†Ø§.";
      bigTiles.style.display="none";
      stageBlock.style.display="none";
    }

    // ===== Mode switching =====
    function setMode(mode){
      const isView = mode==="view";
      const isManage = mode==="manage";
      const isSettings = mode==="settings";

      tabView.classList.toggle("active", isView);
      tabManage.classList.toggle("active", isManage);
      tabSettings.classList.toggle("active", isSettings);

      tabView.setAttribute("aria-selected", isView ? "true" : "false");
      tabManage.setAttribute("aria-selected", isManage ? "true" : "false");
      tabSettings.setAttribute("aria-selected", isSettings ? "true" : "false");

      viewPane.style.display = isView ? "" : "none";
      managePane.style.display = isManage ? "" : "none";
      settingsPane.style.display = isSettings ? "" : "none";

      save();
    }

    function rerenderAll(){
      renderCards();
      renderRows();
      if(selectedId) selectCard(selectedId);
      else updateInspectorEmpty();
    }

    // ===== Import/Export JSON =====
    const jsonFile = document.getElementById("jsonFile");
    document.getElementById("btnExportJSON").addEventListener("click", ()=>{
      const data={
        settings:{
          returnRate:returnRate.value,
          goalScope:goalScope.value,
          leftDensity:leftDensity.value
        },
        stages, cards
      };
      downloadBlob("compounds_data.json", new Blob([JSON.stringify(data,null,2)], {type:"application/json"}));
    });
    document.getElementById("btnImportJSON").addEventListener("click", ()=>jsonFile.click());
    jsonFile.addEventListener("change", async ()=>{
      const f=jsonFile.files?.[0];
      if(!f) return;
      try{
        const txt=await f.text();
        const d=JSON.parse(txt);
        if(d?.settings){
          if(d.settings.returnRate!=null) returnRate.value=d.settings.returnRate;
          if(d.settings.goalScope!=null) goalScope.value=d.settings.goalScope;
          if(d.settings.leftDensity!=null) leftDensity.value=d.settings.leftDensity;
        }
        if(Array.isArray(d.stages)) stages=d.stages;
        if(Array.isArray(d.cards)) cards=d.cards;
        // normalize
        cards = cards.map(c=>normalizeCard(c, c.id||uid())).filter(c=>c.branch_name);
        if(!Array.isArray(stages) || !stages.length) stages=defaultStages();
        selectedId = cards[0]?.id || null;

        renderStages(); rerenderAll(); save();
      }catch(e){
        alert("Ù…Ù„Ù JSON ØºÙŠØ± ØµØ§Ù„Ø­.");
      }finally{
        jsonFile.value="";
      }
    });

    // ===== Wire buttons =====
    document.getElementById("btnApplyPaste").addEventListener("click", applyPaste);
    document.getElementById("btnAddRow").addEventListener("click", ()=>{
      cards.push(normalizeCard({branch_name:"", total_cost:"", students:"", covered_current_pct:"", covered_current_amount:""}, uid()));
      renderRows(); renderCards(); markDirty(); save();
    });
    document.getElementById("btnClear").addEventListener("click", ()=>{
      if(confirm("Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")){
        cards=[]; selectedId=null;
        renderRows(); renderCards(); updateInspectorEmpty(); markDirty(); save();
      }
    });

    document.getElementById("btnAddStage").addEventListener("click", ()=>{
      const last = stages.length ? parseNumber(stages[stages.length-1].target_pct) : 0;
      const next = Number.isFinite(last) ? Math.min(100, Math.max(0, last + 5)) : 10;
      stages.push({id:uid(), name:`Ù…Ø±Ø­Ù„Ø© ${stages.length+1}`, period:"", target_pct:next});
      renderStages(); markDirty(); save(); rerenderAll();
    });
    document.getElementById("btnResetStages").addEventListener("click", ()=>{
      stages=defaultStages();
      renderStages(); markDirty(); save(); rerenderAll();
    });

    // Settings events
    returnRate.addEventListener("input", ()=>{ markDirty(); save(); rerenderAll(); });
    goalScope.addEventListener("change", ()=>{ markDirty(); save(); rerenderAll(); });
    leftDensity.addEventListener("change", ()=>{ markDirty(); save(); renderCards(); });

    // Sync UI events
    btnFetchRemote?.addEventListener("click", ()=>fetchRemoteOnce(false));
    btnPublishRemote?.addEventListener("click", publishRemote);

    remoteGetUrl?.addEventListener("change", ()=>{ markDirty(); save(); startSyncTimer(); });
    remoteAutoOn?.addEventListener("change", ()=>{ markDirty(); save(); startSyncTimer(); });
    remoteInterval?.addEventListener("change", ()=>{ markDirty(); save(); startSyncTimer(); });
    remotePushUrl?.addEventListener("change", ()=>{ markDirty(); save(); });
    remoteToken?.addEventListener("change", ()=>{ markDirty(); save(); });

    // Sheet events
    const sheetBackdrop = document.getElementById("sheetBackdrop");
    const detailSheet = document.getElementById("detailSheet");
    const sheetClose = document.getElementById("sheetClose");
    const sheetPrev = document.getElementById("sheetPrev");
    const sheetNext = document.getElementById("sheetNext");
    sheetBackdrop?.addEventListener("click", closeDetailSheet);
    sheetClose?.addEventListener("click", closeDetailSheet);
    sheetPrev?.addEventListener("click", ()=>sheetGo(-1));
    sheetNext?.addEventListener("click", ()=>sheetGo(1));

    // ESC closes
    window.addEventListener("keydown", (e)=>{ if(e.key==="Escape" && detailSheet && !detailSheet.hidden) closeDetailSheet(); });

    // When search changes, keep nav state accurate
    elSearch?.addEventListener("input", ()=>{ if(detailSheet && !detailSheet.hidden) syncSheetNav(); });


    document.getElementById("btnExportCSS").addEventListener("click", ()=>{
      const css=document.getElementById("appCSS")?.innerHTML || "";
      downloadBlob("compound_board.css", new Blob([css], {type:"text/css;charset=utf-8"}));
    });

    document.getElementById("btnResetAll").addEventListener("click", ()=>{
      if(!confirm("Ø¥Ø±Ø¬Ø§Ø¹ ÙƒÙ„ Ø´ÙŠØ¡ Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©ØŸ")) return;
      localStorage.removeItem(LS);
      location.reload();
    });

    // Tabs
    tabView.addEventListener("click", ()=>setMode("view"));
    tabManage.addEventListener("click", ()=>setMode("manage"));
    tabSettings.addEventListener("click", ()=>setMode("settings"));

    // Search
    elSearch.addEventListener("input", renderCards);

    // Sample data
    document.getElementById("btnAddSample").addEventListener("click", ()=>{
      cards=[
        normalizeCard({branch_name:"Ù…Ø¬Ù…Ø¹ Ø²ÙŠØ¯ Ø¨Ù† Ø«Ø§Ø¨Øª", total_cost:"123234", students:"420", covered_current_pct:"37"}, "seed1"),
        normalizeCard({branch_name:"Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¥Ù…Ø§Ù… Ø¹Ø§ØµÙ…", total_cost:"310000", students:"980", covered_current_amount:"115000"}, "seed2"),
        normalizeCard({branch_name:"Ù…Ø¬Ù…Ø¹ Ø­ÙØµØ© Ø¨Ù†Øª Ø¹Ù…Ø±", total_cost:"180000", students:"520", covered_current_pct:"22"}, "seed3"),
        normalizeCard({branch_name:"Ù…Ø¬Ù…Ø¹ Ø¹Ø«Ù…Ø§Ù† Ø¨Ù† Ø¹ÙØ§Ù†", total_cost:"265000", students:"730", covered_current_amount:"92000"}, "seed4"),
      ];
      if(!stages.length) stages=defaultStages();
      selectedId=cards[0].id;
      renderStages(); rerenderAll(); save();
      setMode("view");
    });

    
    // ===== Shared sync (polling) =====
    function setSyncBadge(text, ok){
      if(!syncState) return;
      syncState.textContent = text;
      syncState.style.borderColor = ok ? "rgba(16,185,129,.35)" : "rgba(245,158,11,.35)";
      syncState.style.color = "rgba(11,18,32,.78)";
      syncState.style.background = ok ? "rgba(16,185,129,.10)" : "rgba(245,158,11,.10)";
    }

    async function fetchRemoteOnce(silent=false){
      const url = (remoteGetUrl?.value || "").trim();
      if(!url){
        if(!silent) alert("Ø¶Ø¹ Ø±Ø§Ø¨Ø· JSON (GET) ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£ÙˆÙ„Ù‹Ø§.");
        setSyncBadge("ØºÙŠØ± Ù…ØªØµÙ„", false);
        return false;
      }
      try{
        setSyncBadge("ÙŠØªØ­Ù‚Ù‚â€¦", true);
        const u = new URL(url, location.href);
        u.searchParams.set("_ts", Date.now().toString()); // cache-bust
        const res = await fetch(u.toString(), {cache:"no-store"});
        if(!res.ok) throw new Error("HTTP "+res.status);
        const data = await res.json();

        const remoteUpdated = Number(data?.meta?.updated_at || 0) || 0;
        if(remoteUpdated && remoteUpdated <= (localUpdatedAt||0)){
          setSyncBadge("Ù…Ø­Ø¯Ù‘Ø«", true);
          return true;
        }

        // Apply remote data
        if(data?.settings){
          if(data.settings.returnRate!=null) returnRate.value = data.settings.returnRate;
          if(data.settings.goalScope!=null) goalScope.value = data.settings.goalScope;
          if(data.settings.leftDensity!=null) leftDensity.value = data.settings.leftDensity;
        }
        if(Array.isArray(data?.stages)) stages = data.stages;
        if(Array.isArray(data?.cards)) cards = data.cards;

        cards = (cards||[]).map(c=>normalizeCard(c, c.id||uid())).filter(c=>c.branch_name);
        if(!Array.isArray(stages) || !stages.length) stages = defaultStages();

        localUpdatedAt = remoteUpdated || Date.now();
        selectedId = (selectedId && cards.some(c=>c.id===selectedId)) ? selectedId : (cards[0]?.id || null);
        if(!selectedId) setCardHash(null);

        renderStages();
        renderRows();
        renderCards();
        if(selectedId) selectCard(selectedId);
        else updateInspectorEmpty();

        save();
        setSyncBadge("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«", true);
        return true;
      }catch(e){
        setSyncBadge("ØªØ¹Ø°Ø± Ø§Ù„Ø¬Ù„Ø¨", false);
        if(!silent) alert("ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·.\nØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ùˆ CORS.");
        return false;
      }
    }

    function startSyncTimer(){
      stopSyncTimer();
      const on = (remoteAutoOn?.value || "on") === "on";
      const url = (remoteGetUrl?.value || "").trim();
      if(!on || !url){
        setSyncBadge("ØºÙŠØ± Ù…ØªØµÙ„", false);
        return;
      }
      const sec = clamp(parseNumber(remoteInterval?.value || 20) || 20, 5, 300);
      setSyncBadge(`Ù…Ø²Ø§Ù…Ù†Ø© ÙƒÙ„ ${sec}Ø«`, true);
      syncTimer = setInterval(()=>fetchRemoteOnce(true), sec*1000);
      fetchRemoteOnce(true);
    }

    function stopSyncTimer(){
      if(syncTimer){ clearInterval(syncTimer); syncTimer=null; }
    }

    async function publishRemote(){
      const push = (remotePushUrl?.value || "").trim();
      if(!push){
        // fallback: export JSON for manual upload
        const data={
          meta:{ updated_at: Date.now(), schema: 1 },
          settings:{
            returnRate:returnRate.value,
            goalScope:goalScope.value,
            leftDensity:leftDensity.value
          },
          stages, cards
        };
        downloadBlob("compounds_data.json", new Blob([JSON.stringify(data,null,2)], {type:"application/json"}));
        alert("Ù…Ø§ ÙÙŠÙ‡ Ø±Ø§Ø¨Ø· Ø­ÙØ¸ (POST).\nØªÙ… ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù JSON â€” Ø§Ø±ÙØ¹Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ù†ÙØ³ Ø±Ø§Ø¨Ø· GET Ù„ÙŠØµÙ„ Ù„Ù„Ø¬Ù…ÙŠØ¹.");
        return;
      }

      try{
        setSyncBadge("ÙŠÙ†Ø´Ø±â€¦", true);
        const payload={
          meta:{ updated_at: Date.now(), schema: 1 },
          settings:{
            returnRate:returnRate.value,
            goalScope:goalScope.value,
            leftDensity:leftDensity.value
          },
          stages, cards
        };

        const headers = {"Content-Type":"application/json"};
        const token = (remoteToken?.value || "").trim();
        if(token) headers["Authorization"] = "Bearer " + token;

        const res = await fetch(push, {method:"POST", headers, body: JSON.stringify(payload)});
        if(!res.ok) throw new Error("HTTP "+res.status);

        localUpdatedAt = payload.meta.updated_at;
        save();
        setSyncBadge("ØªÙ… Ø§Ù„Ù†Ø´Ø±", true);
        fetchRemoteOnce(true);
        alert("ØªÙ… Ù†Ø´Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âœ…\n(Ø¥Ø°Ø§ ÙƒØ§Ù† Ø±Ø§Ø¨Ø· GET ÙŠØ´ÙŠØ± Ù„Ù†ÙØ³ Ø§Ù„Ù…ØµØ¯Ø±ØŒ Ø³ÙŠØµÙ„ Ù„Ù„Ø¬Ù…ÙŠØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§).");
      }catch(e){
        setSyncBadge("ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø´Ø±", false);
        alert("ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø´Ø± Ø¹Ø¨Ø± Ø±Ø§Ø¨Ø· Ø§Ù„Ø­ÙØ¸.\nØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ùˆ CORS ÙˆØ·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚.");
      }
    }


    
    // ===== Mobile nav wiring (no feature changes) =====
    (function(){
      const nav = document.querySelector(".mNav");
      if(!nav) return;
      nav.addEventListener("click", (e)=>{
        const btn = e.target.closest(".mNavBtn");
        if(!btn) return;
        const tgt = btn.getAttribute("data-target");
        const act = btn.getAttribute("data-action");
        if(tgt){
          const el = document.getElementById(tgt);
          if(el) el.click();
        }else if(act==="print"){
          document.getElementById("btnPrint")?.click();
        }else if(act==="images"){
          // Prefer ZIP export of images when available; fallback to single images export
          document.getElementById("btnExportZip")?.click() || document.getElementById("btnExportImages")?.click();
        }
      });
    })();


    
    // ===== Direct-to-card deep link + focus (mobile friendly) =====
    function setCardHash(id){
      try{
        const url = new URL(location.href);
        if(id) url.hash = "card=" + encodeURIComponent(id);
        else url.hash = "";
        history.replaceState(null, "", url.toString());
      }catch(e){}
    }
    function getCardHash(){
      try{
        const h = (location.hash || "").replace(/^#/, "");
        if(!h) return null;
        const m = h.match(/(?:^|&)card=([^&]+)/);
        return m ? decodeURIComponent(m[1]) : null;
      }catch(e){ return null; }
    }
    function focusCardInList(id){
      const el = document.querySelector(`[data-card-id="${CSS.escape(id)}"]`);
      if(el){
        el.scrollIntoView({behavior:"smooth", block:"center", inline:"nearest"});
        el.classList.add("pulseFocus");
        setTimeout(()=>el.classList.remove("pulseFocus"), 900);
      }
    }


    
    // ===== Embedded Data (no external JSON) =====
    const EMBEDDED_DATA = {"meta":{"updated_at":1770190149297,"schema":1},"settings":{"returnRate":"9","goalScope":"remaining","leftDensity":"calm"},"stages":[{"id":"c4d46a48de82819c1d437a04","name":"Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰","period":"Ø®Ù„Ø§Ù„ Ø±Ù…Ø¶Ø§Ù†","target_pct":65},{"id":"9c714750d657e819c1d437a04","name":"Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©","period":"Ø¨Ø¹Ø¯ Ø±Ù…Ø¶Ø§Ù†","target_pct":80},{"id":"a5e96be5544dc819c1d437a04","name":"Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©","period":"Ù†ØµÙ Ø§Ù„Ø³Ù†Ø©","target_pct":90},{"id":"b70be1ad4674419c1d437a04","name":"Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©","period":"Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø³Ù†Ø©","target_pct":100}],"cards":[{"id":"ea0eedaf4968f819c1d442fda","branch_name":"Ù…Ø¬Ù…Ø¹ Ø£Ø¨ÙŠ Ø¨Ù† ÙƒØ¹Ø¨","total_cost":146780,"students":95,"covered_current_amount":62700,"covered_current_pct":42.716991415724216},{"id":"f53da43ee5c0f819c1d442fda","branch_name":"Ù…Ø¬Ù…Ø¹ Ø³Ø¹ÙŠØ¯ Ø¨Ù† Ø²ÙŠØ¯","total_cost":118240,"students":78,"covered_current_amount":50050,"covered_current_pct":42.32916102841678},{"id":"ada7aec5169d119c1d442fda","branch_name":"Ù…Ø¬Ù…Ø¹ Ø£Ø³Ø§Ù…Ø© Ø¨Ù† Ø²ÙŠØ¯","total_cost":233640,"students":163,"covered_current_amount":99000,"covered_current_pct":42.3728813559322},{"id":"0923f01d6c733819c1d442fda","branch_name":"Ù…Ø¬Ù…Ø¹ Ø¹Ù…Ø± Ø¨Ù† Ø§Ù„Ø®Ø·Ø§Ø¨","total_cost":253980,"students":180,"covered_current_amount":116050,"covered_current_pct":45.692574218442395},{"id":"d4eeb6ea9aaa3819c1d442fda","branch_name":"Ù…Ø¬Ù…Ø¹ Ø¬Ø§Ù…Ø¹ Ø§Ù„Ù…ØµÙŠØ±ÙŠØ¹ÙŠ","total_cost":166140,"students":123,"covered_current_amount":68750,"covered_current_pct":41.38076321174913},{"id":"d90ecc198741a19c1d442fda","branch_name":"Ù…Ø¬Ù…Ø¹ Ù…ØµØ¹Ø¨ Ø¨Ù† Ø¹Ù…ÙŠØ±","total_cost":281960,"students":214,"covered_current_amount":117150,"covered_current_pct":41.54844658816854},{"id":"b5636561846bb819c1d442fda","branch_name":"Ù…Ø¬Ù…Ø¹ Ø¹ØªØ¨Ø© Ø¨Ù† ØºØ²ÙˆØ§Ù†","total_cost":344760,"students":263,"covered_current_amount":143000,"covered_current_pct":41.47812971342383},{"id":"bc524b400b88919c1d442fda","branch_name":"Ù…Ø¬Ù…Ø¹ Ø³Ø¹Ø¯ Ø¨Ù† Ù…Ø¹Ø§Ø°","total_cost":103820,"students":81,"covered_current_amount":41800,"covered_current_pct":40.261991909073394},{"id":"3c693e871468519c1d442fda","branch_name":"Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø²Ø¨ÙŠØ± Ø¨Ù† Ø§Ù„Ø¹ÙˆØ§Ù…","total_cost":146980,"students":120,"covered_current_amount":64900,"covered_current_pct":44.15566743774663},{"id":"de68c335239fb819c1d442fda","branch_name":"Ù…Ø¬Ù…Ø¹ Ø¹Ø«Ù…Ø§Ù† Ø¨Ù† Ø¹ÙØ§Ù†","total_cost":412120,"students":350,"covered_current_amount":166650,"covered_current_pct":40.437251286033195},{"id":"4eb0811e61aac819c1d442fda","branch_name":"Ù…Ø¬Ù…Ø¹ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø¨Ù† Ø¹Ø¨Ø§Ø³","total_cost":58920,"students":52,"covered_current_amount":22000,"covered_current_pct":37.3387644263408},{"id":"cf2a29464489119c1d442fda","branch_name":"Ù…Ø¬Ù…Ø¹ Ø²ÙŠØ¯ Ø¨Ù† Ø«Ø§Ø¨Øª","total_cost":353520,"students":348,"covered_current_amount":135300,"covered_current_pct":38.27223353699932},{"id":"126e311c1e8ef19c1d442fda","branch_name":"Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø­Ù„Ù‚Ø§Øª Ø§Ù„Ù…Ù†ÙØ±Ø¯Ø©","total_cost":90680,"students":96,"covered_current_amount":33000,"covered_current_pct":36.39170710189678},{"id":"7d101dc3d7ab1819c1d442fda","branch_name":"Ù…Ø¬Ù…Ø¹ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø¨Ù† Ù…Ø³Ø¹ÙˆØ¯","total_cost":88520,"students":97,"covered_current_amount":31350,"covered_current_pct":35.41572525982829},{"id":"416a5fa56e90919c1d442fda","branch_name":"Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø­Ù„Ù‚Ø§Øª Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©","total_cost":284720,"students":370,"covered_current_amount":95700,"covered_current_pct":33.6119696543973},{"id":"deb8d3cd40e8919c1d442fda","branch_name":"Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø­Ù„Ù‚ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©","total_cost":95320,"students":194,"covered_current_amount":20900,"covered_current_pct":21.926143516575745}]};
// ===== Init =====
    (async function init(){
      // Load UI prefs (if any) but data comes from the embedded dataset.
      load();

      // Always use embedded dataset as the single source of truth for cards/stages.
      try{
        stages = Array.isArray(EMBEDDED_DATA.stages) && EMBEDDED_DATA.stages.length ? EMBEDDED_DATA.stages : defaultStages();
        cards  = Array.isArray(EMBEDDED_DATA.cards)  ? EMBEDDED_DATA.cards : [];
      }catch(_){
        stages = defaultStages();
        cards = [];
      }

      // Normalize before first render
      if(!Array.isArray(stages) || !stages.length) stages = defaultStages();
      cards = (cards||[]).map(c=>normalizeCard(c, c.id||uid())).filter(c=>c.branch_name);

      renderStages();
      renderRows();
      renderCards();

      if(selectedId && cards.some(c=>c.id===selectedId)) selectCard(selectedId);
      else if(cards[0]) selectCard(cards[0].id);
      else updateInspectorEmpty();

      setMode("view");
      save();

      // No remote sync â€” data is embedded in index.html
      setSyncBadge("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¯Ù…Ø¬Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø©", true);
    })();
  </script>

  <!-- Mobile detail sheet (prevents jumping/scrolling to bottom on long lists) -->
  <div class="sheetBackdrop no-print" id="sheetBackdrop" hidden></div>
  <section class="sheet no-print" id="detailSheet" hidden aria-label="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…Ø¹">
    <div class="sheetHandle" id="sheetHandle" aria-hidden="true"></div>
    <div class="sheetHead">
      <div class="sheetTitle">
        <div class="sheetKicker">ØªÙØ§ØµÙŠÙ„</div>
        <div class="sheetName" id="sheetName">â€”</div>
      </div>
      <div class="sheetNav">
        <button class="btn small" id="sheetPrev" title="Ø§Ù„Ø³Ø§Ø¨Ù‚">â€¹</button>
        <button class="btn small" id="sheetNext" title="Ø§Ù„ØªØ§Ù„ÙŠ">â€º</button>
        <button class="btn small" id="sheetClose" title="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
      </div>
    </div>
    <div class="sheetBody" id="sheetBody"></div>
  </section>

</body>
</html>
